<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>หน่วยปฏิบัติการอำนวยการ</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #f1f5f9;
            /* Slate 100 */
            color: #334155;
            /* Slate 700 */
            font-family: 'Prompt', sans-serif;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100%;
            z-index: 1;
        }

        .header {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 5px solid #1a365d;
            /* NIEMS Navy Blue */
            max-width: 400px;
        }

        .header img {
            height: 50px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .header-text {
            display: flex;
            flex-direction: column;
        }

        .header h1 {
            margin: 0;
            font-size: 1.1rem;
            color: #1a365d;
            /* NIEMS Navy Blue */
            font-weight: 600;
            line-height: 1.2;
        }

        .header p {
            margin: 2px 0 0;
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 300;
        }

        /* Custom Marker Styles */
        .blinking-marker {
            background-color: #ef4444;
            /* Red 500 */
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 0 rgba(239, 68, 68, 0.4);
            animation: pulse 2s infinite;
        }

        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #ef4444;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .marker-pin::after {
            content: '';
            width: 14px;
            height: 14px;
            margin: 8px 0 0 8px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }

        .custom-div-icon {
            background: none;
            border: none;
        }

        .custom-div-icon i {
            position: absolute;
            width: 22px;
            height: 22px;
            left: 0;
            right: 0;
            margin: 10px auto;
            text-align: center;
            font-size: 12px;
            /* icon size */
            color: white;
            /* icon color */
            padding-top: 5px;
            /* adjust to center */
            z-index: 100;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        @keyframes pulse-gold {
            0% {
                box-shadow: 0 0 0 0 rgba(212, 163, 47, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(212, 163, 47, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(212, 163, 47, 0);
            }
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        @keyframes pulse-blue {
            0% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(37, 99, 235, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
            }
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }


        /* Warning Popup */
        .leaflet-popup-content-wrapper {
            background: rgba(255, 255, 255, 0.98);
            color: #334155;
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            font-family: 'Prompt', sans-serif;
        }

        .leaflet-popup-tip {
            background: rgba(255, 255, 255, 0.98);
        }

        .leaflet-popup-content {
            margin: 14px;
        }

        .info-row {
            margin-bottom: 6px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        .info-label {
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .info-value {
            color: #1a365d;
            font-weight: 500;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            border-radius: 20px;
            z-index: 1000;
            font-size: 0.85rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            width: 300px;
        }

        .legend-title {
            margin-bottom: 5px;
            font-weight: 600;
            color: #1a365d;
            font-size: 1rem;
            text-align: center;
            letter-spacing: 0.5px;
        }

        .legend-subtitle {
            font-size: 0.75rem;
            color: #64748b;
            text-align: center;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .legend-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }

        .filter-btn.active {
            border-color: currentColor;
            transform: translateY(-1px);
            font-weight: 600;
        }

        .filter-btn.active.rnis {
            background-color: #eff6ff;
            /* Blue 50 */
            color: #1d4ed8;
            /* Blue 700 */
            border: 2px solid #93c5fd;
            /* Blue 300 */
        }

        .filter-btn.active.high {
            background-color: #f8fafc;
            /* Slate 50 */
            color: #475569;
            /* Slate 600 */
            border: 2px solid #cbd5e1;
            /* Slate 300 */
        }

        .filter-btn.active.basic {
            background-color: #f8fafc;
            /* Slate 50 */
            color: #475569;
            /* Slate 600 */
            border: 2px solid #cbd5e1;
            /* Slate 300 */
        }

        .btn-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #cbd5e1;
            transition: all 0.3s;
            border: 1px solid #e2e8f0;
            position: relative;
            /* For crown overlap */
            overflow: visible;
        }

        .btn-icon img {
            width: 18px;
            height: 18px;
            object-fit: contain;
        }

        .filter-btn.active .btn-icon {
            border-color: transparent;
        }

        /* Icon styling to match the active state text color or distinct */
        .filter-btn.active.rnis {
            background-color: #fefce8;
            color: #854d0e;
            border: 2px solid #d4a32f;
            box-shadow: 0 4px 12px rgba(212, 163, 47, 0.2);
        }

        .filter-btn.active.rnis .btn-icon {
            background: #d4a32f !important;
            color: white;
            border: 2px solid white;
        }

        .filter-btn.active.high {
            background-color: #fef2f2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        .filter-btn.active.high .btn-icon {
            background: #ef4444 !important;
            border: 2px solid white;
        }

        .filter-btn.active.basic {
            background-color: #eff6ff;
            color: #1e40af;
            border: 2px solid #2563eb;
        }

        .filter-btn.active.basic .btn-icon {
            background: #2563eb !important;
            border: 2px solid white;
        }

        .filter-btn.active.advisor {
            background-color: #ecfdf5;
            color: #065f46;
            border: 2px solid #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .filter-btn.active.advisor .btn-icon {
            background: #10b981 !important;
            color: white;
            border: 2px solid white;
        }

        .btn-icon img.telephone-icon,
        .btn-icon img.headset-icon {
            filter: brightness(0) invert(1);
        }

        .btn-label {
            font-size: 0.9rem;
        }

        .btn-count {
            background: #f1f5f9;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
        }

        .filter-btn.active .btn-count {
            background: white;
            color: currentColor;
            opacity: 0.8;
        }

        /* Mobile Legend Optimization */
        .mobile-legend-toggle {
            display: none;
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1100;
            background: white;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #1a365d;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            .mobile-legend-toggle {
                display: flex;
            }

            .legend {
                top: 80px;
                right: -320px;
                /* Hidden by default */
                transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                width: 280px;
                max-height: calc(100vh - 100px);
                overflow-y: auto;
            }

            .legend.mobile-active {
                right: 20px;
            }

            .header {
                max-width: 280px;
                padding: 10px 15px;
                top: 15px;
                left: 15px;
                font-size: 0.85rem;
            }

            .header h1 {
                font-size: 1.1rem;
            }
        }

        /* Feature Comparison Modal Styles */
        .info-btn {
            background: #f1f5f9;
            color: #64748b;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            margin-left: 8px;
            vertical-align: middle;
            border: 1px solid #cbd5e1;
        }

        .info-btn:hover {
            background: #e2e8f0;
            color: #1a365d;
            transform: scale(1.1);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .close-btn {
            background: #f1f5f9;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #fee2e2;
            color: #ef4444;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .comparison-table th {
            text-align: center;
            padding: 15px 10px;
            background: #f8fafc;
            color: #475569;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .comparison-table th:first-child {
            text-align: left;
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
        }

        .comparison-table th:last-child {
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .comparison-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #f1f5f9;
            text-align: center;
        }

        .comparison-table td:first-child {
            text-align: left;
            font-weight: 400;
            color: #334155;
            width: 50%;
        }

        .comparison-table tr:hover td {
            background: rgba(248, 250, 252, 0.5);
        }

        .check-icon {
            color: #10b981;
            font-size: 1.2rem;
        }

        .cross-icon {
            color: #cbd5e1;
            font-size: 1rem;
            opacity: 0.5;
        }

        .tag-digital {
            background: #fefce8;
            color: #854d0e;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #d4a32f;
        }

        .tag-general {
            background: #f1f5f9;
            color: #64748b;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #cbd5e1;
        }

        @media (max-width: 600px) {
            .modal-content {
                padding: 20px;
                width: 95%;
            }

            .comparison-table {
                font-size: 0.85rem;
            }

            .modal-header h2 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>

<body>

    <div class="header">
        <img src="logo-200.png" alt="NIEMS Logo">
        <div class="header-text">
            <h1>หน่วยปฏิบัติการอำนวยการ</h1>
            <p>สถาบันการแพทย์ฉุกเฉินแห่งชาติ (สพฉ.)</p>
        </div>
    </div>

    <div id="map"></div>

    <div class="mobile-legend-toggle" onclick="toggleMobileLegend()">
        <i class="fa-solid fa-layer-group"></i>
    </div>

    <div class="legend" id="mainLegend">
        <div class="legend-title">
            ระดับหน่วยปฏิบัติการอำนวยการ
            <div class="info-btn" onclick="openModal()" title="ความสามารถของระบบ NDEMS ณ
                    หน่วยปฏิบัติการอำนวยการ (ศูนย์สั่งการที่ยกระดับ)">
                <i class="fa-solid fa-info"></i>
            </div>
        </div>
        <div class="legend-subtitle">คลิกที่ระดับปฏิบัติการเพื่อเปิด/ปิดการแสดงผล</div>
        <div class="legend-grid">
            <div class="filter-btn active rnis" onclick="toggleLayer('rnis', this)">
                <div class="btn-content">
                    <div class="btn-icon">
                        <img src="headset.png" alt="Headset" class="headset-icon">
                        <i class="fa-solid fa-crown" style="
                            position: absolute;
                            top: -12px;
                            left: 50%;
                            transform: translateX(-50%);
                            color: #fbbf24;
                            font-size: 14px;
                            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
                        "></i>
                    </div>
                    <span class="btn-label">ยกระดับเป็นดิจิทัล</span>
                </div>
                <span class="btn-count" id="count-rnis">0</span>
            </div>

            <div class="filter-btn active advisor" onclick="toggleLayer('advisor', this)">
                <div class="btn-content">
                    <div class="btn-icon"><i class="fa-solid fa-user-doctor" style="font-size: 18px;"></i></div>
                    <span class="btn-label">ระดับที่ปรึกษา</span>
                </div>
                <span class="btn-count" id="count-advisor">0</span>
            </div>

            <div class="filter-btn active high" onclick="toggleLayer('high', this)">
                <div class="btn-content">
                    <div class="btn-icon"><img src="telephone.png" alt="Telephone" class="telephone-icon"></div>
                    <span class="btn-label">ระดับสูง</span>
                </div>
                <span class="btn-count" id="count-high">0</span>
            </div>

            <div class="filter-btn active basic" onclick="toggleLayer('basic', this)">
                <div class="btn-content">
                    <div class="btn-icon"><img src="telephone.png" alt="Telephone" class="telephone-icon"></div>
                    <span class="btn-label">ระดับพื้นฐาน</span>
                </div>
                <span class="btn-count" id="count-basic">0</span>
            </div>
        </div>
    </div>
    <!-- Feature Comparison Modal -->
    <div class="modal-overlay" id="comparisonModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fa-solid fa-layer-group" style="color: #d4a32f;"></i> ความสามารถของระบบ NDEMS ณ
                    หน่วยปฏิบัติการอำนวยการ (ศูนย์สั่งการที่ยกระดับ)</h3>
                <button class="close-btn" onclick="closeModal()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>ฟังก์ชันการทำงาน</th>
                        <th><span class="tag-digital">ศูนย์สั่งการที่ยกระดับ</span></th>
                        <th><span class="tag-general">ศูนย์สั่งการที่ยังไม่ยกระดับ</span></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1. รับแจ้งเหตุผ่านดิจิทัลได้ทุกรูปแบบ</td>
                        <td><i class="fa-solid fa-circle-check check-icon"></i></td>
                        <td><i class="fa-solid fa-circle-xmark cross-icon"></i></td>
                    </tr>
                    <tr>
                        <td>2. สนทนาผ่านอุปกรณ์ Headset โดยไม่ต้องยกหูโทรศัพท์</td>
                        <td><i class="fa-solid fa-circle-check check-icon"></i></td>
                        <td><i class="fa-solid fa-circle-xmark cross-icon"></i></td>
                    </tr>
                    <tr>
                        <td>3. เชื่อมต่อระบบแจ้ง (RNIS) กับระบบบันทึกข้อมูลสั่งการ (EMS Portal) อัตโนมัติ </td>
                        <td><i class="fa-solid fa-circle-check check-icon"></i></td>
                        <td><i class="fa-solid fa-circle-xmark cross-icon"></i></td>
                    </tr>
                    <tr>
                        <td>4. รองรับการทำงานผ่านอินเตอร์เน็ต</td>
                        <td><i class="fa-solid fa-circle-check check-icon"></i></td>
                        <td><i class="fa-solid fa-circle-xmark cross-icon"></i></td>
                    </tr>
                    <tr>
                        <td>5. ระบบบริหารจัดการสายก่อกวน</td>
                        <td><i class="fa-solid fa-circle-check check-icon"></i></td>
                        <td><i class="fa-solid fa-circle-xmark cross-icon"></i></td>
                    </tr>
                    <tr>
                        <td>6. ระบบจัดการรายชื่อผู้แจ้ง/ผู้ป่วย เช่น มีระบบบันทึกข้อมูลผู้แจ้งเหตุฉุกเฉิน
                            ผู้ป่วยกลุ่มเปราะบาง</td>
                        <td><i class="fa-solid fa-circle-check check-icon"></i></td>
                        <td><i class="fa-solid fa-circle-xmark cross-icon"></i></td>
                    </tr>
                    <tr>
                        <td>7. ระบบโอนสายจาก Call Taker ไปยัง Dispatcher</td>
                        <td><i class="fa-solid fa-circle-check check-icon"></i></td>
                        <td><i class="fa-solid fa-circle-xmark cross-icon"></i></td>
                    </tr>
                    <tr>
                        <td>8. ระบบรายงานสถิติการรับแจ้งเหตุฉุกเฉิน (RNIS IQM) บันทึกระยะเวลาโทรเข้า-รับสาย-โทรออก
                            มีระบบบันทึกเสียงการสนทนา</td>
                        <td><i class="fa-solid fa-circle-check check-icon"></i></td>
                        <td><i class="fa-solid fa-circle-xmark cross-icon"></i></td>
                    </tr>
                    <tr>
                        <td>9. ระบบรายงานสถิติการโทรแจ้งเหตุ (RNIS Dashboard)</td>
                        <td><i class="fa-solid fa-circle-check check-icon"></i></td>
                        <td><i class="fa-solid fa-circle-xmark cross-icon"></i></td>
                    </tr>
                    <tr>
                        <td>10. รองรับการแจ้งเหตุผ่านแอปหมอพร้อม และทางรัฐ</td>
                        <td><i class="fa-solid fa-circle-check check-icon"></i></td>
                        <td><i class="fa-solid fa-circle-xmark cross-icon"></i></td>
                    </tr>
                    <tr>
                        <td>11. รองรับเทคโนโลยีระบุตำแหน่งฉุกเฉินอัตโนมัติบนมือถือที่ส่งพิกัด GPS ความแม่นยำสูง หรือ AML
                            : Advanced Mobile Lacation</td>
                        <td><i class="fa-solid fa-circle-check check-icon"></i></td>
                        <td><i class="fa-solid fa-circle-xmark cross-icon"></i></td>
                    </tr>
                    <tr>
                        <td>12. รองรับสถานการณ์ไม่ปกติและภัยพิบัติ เช่น ตั้งศูนย์รับแจ้งเหตุสั่งการเสมือน (Virtual
                            Dispatch Center)</td>
                        <td><i class="fa-solid fa-circle-check check-icon"></i></td>
                        <td><i class="fa-solid fa-circle-xmark cross-icon"></i></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="command-centers.js"></script>
    <script>
        // Modal Functions
        function openModal() {
            const modal = document.getElementById('comparisonModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeModal() {
            const modal = document.getElementById('comparisonModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // Close modal when clicking outside content
        window.onclick = function (event) {
            const modal = document.getElementById('comparisonModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        function toggleMobileLegend() {
            const legend = document.getElementById('mainLegend');
            legend.classList.toggle('mobile-active');

            const icon = document.querySelector('.mobile-legend-toggle i');
            if (legend.classList.contains('mobile-active')) {
                icon.classList.remove('fa-layer-group');
                icon.classList.add('fa-xmark');
            } else {
                icon.classList.remove('fa-xmark');
                icon.classList.add('fa-layer-group');
            }
        }

        // Initialize Map centered on Thailand
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            maxBounds: [
                [5.0, 97.0],  // Southwest corner
                [21.0, 106.0] // Northeast corner
            ],
            minZoom: 5,
            maxBoundsViscosity: 1.0
        }).setView([13.736717, 100.523186], 6);

        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);

        // Light Theme Base Map (CartoDB Positron)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Load Thailand Provinces GeoJSON
        fetch('https://raw.githubusercontent.com/chingchai/OpenGISData-Thailand/master/provinces.geojson')
            .then(response => response.json())
            .then(data => {

                // 1. Calculate Union of all provinces to get Thailand outline
                // This might take a moment, but for ~77 provinces it should be fast enough.
                let thailandUnion = data.features[0];
                for (let i = 1; i < data.features.length; i++) {
                    thailandUnion = turf.union(thailandUnion, data.features[i]);
                }

                // 2. Create a "World Mask" (World Polygon minus Thailand Union)
                const worldPolygon = turf.polygon([[
                    [-180, 90],
                    [-180, -90],
                    [180, -90],
                    [180, 90],
                    [-180, 90]
                ]]);

                const mask = turf.difference(worldPolygon, thailandUnion);

                // 3. Add Mask Layer (White cover for everything else)
                L.geoJSON(mask, {
                    style: {
                        color: 'transparent',
                        fillColor: '#ffffff', // White mask
                        fillOpacity: 0.8,    // 0.8 opacity to dim the world
                        weight: 0
                    }
                }).addTo(map);

                // 4. Add Province Borders (On top of mask? No, mask is around it. Provinces are inside holes.)
                // Actually we just add provinces normally for the borders.
                L.geoJSON(data, {
                    style: function (feature) {
                        return {
                            color: '#64748b',
                            weight: 1,
                            opacity: 0.5,
                            fillColor: 'transparent', // No fill needed as tiles show through
                            fillOpacity: 0
                        };
                    },
                    onEachFeature: function (feature, layer) {
                        layer.on({
                            mouseover: function (e) {
                                var layer = e.target;
                                layer.setStyle({
                                    weight: 2,
                                    color: '#0ea5e9',
                                    fillOpacity: 0.1
                                });
                            },
                            mouseout: function (e) {
                                L.geoJSON(data).resetStyle(e.target);
                                // Proper reset manually since we have custom base style
                                layer.setStyle({
                                    color: '#64748b',
                                    weight: 1,
                                    opacity: 0.5,
                                    fillOpacity: 0
                                });
                            }
                        });
                    }
                }).addTo(map);
            })
            .catch(error => console.error('Error loading GeoJSON:', error));


        // Layer Groups for Filtering
        const layers = {
            'rnis': L.layerGroup().addTo(map),
            'high': L.layerGroup().addTo(map),
            'basic': L.layerGroup().addTo(map),
            'advisor': L.layerGroup().addTo(map)
        };

        // Function to Toggle Layers
        function toggleLayer(level, element) {
            // Check current state by class because we are using active class for styling
            const isActive = element.classList.contains('active');

            if (isActive) {
                map.removeLayer(layers[level]);
                element.classList.remove('active');
            } else {
                map.addLayer(layers[level]);
                element.classList.add('active');
            }
        }

        // Command Center Data is loaded from command-centers.js
        if (typeof commandCenters !== 'undefined' && Array.isArray(commandCenters)) {
            let countRNIS = 0;
            let countHigh = 0;
            let countBasic = 0;
            let countAdvisor = 0;

            commandCenters.forEach(center => {
                if (center.lat && center.lng) {
                    let color, animationName, targetLayer;

                    // 1. Determine Category, Counts, and Base Styling
                    if (center.rnis) {
                        countRNIS++;
                        targetLayer = layers['rnis'];
                        color = '#d4a32f';
                        animationName = 'pulse-gold';
                    } else if (center.level && center.level.includes('ระดับสูง')) {
                        countHigh++;
                        targetLayer = layers['high'];
                        color = '#ef4444';
                        animationName = 'pulse-red';
                    } else if (center.level === "ที่ปรึกษา") {
                        countAdvisor++;
                        targetLayer = layers['advisor'];
                        color = '#10b981';
                        animationName = 'pulse-green';
                    } else {
                        countBasic++;
                        targetLayer = layers['basic'];
                        color = '#2563eb';
                        animationName = 'pulse-blue';
                    }

                    const animationStyle = `animation: ${animationName} 2s infinite;`;

                    // 2. Prepare Icons
                    let crownIcon = '';
                    if (center.rnis) {
                        crownIcon = `<i class="fa-solid fa-crown" style="
                            position: absolute;
                            top: -26px;
                            left: 50%;
                            transform: translateX(-50%);
                            color: #fbbf24; 
                            font-size: 16px; 
                            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
                            z-index: 200;
                        "></i>`;
                    }

                    let iconSize = 14;
                    let innerIcon = '';

                    if (center.level === "ที่ปรึกษา") {
                        innerIcon = `<i class="fa-solid fa-user-doctor" style="font-size: 18px;"></i>`;
                    } else if (!center.rnis) {
                        innerIcon = `<img src="telephone.png" style="width: ${iconSize}px; height: ${iconSize}px; object-fit: contain; filter: brightness(0) invert(1);">`;
                    } else {
                        innerIcon = `<img src="headset.png" style="width: ${iconSize}px; height: ${iconSize}px; object-fit: contain; filter: brightness(0) invert(1);">`;
                    }

                    const iconHtml = `
                        <div style="position: relative;">
                            ${crownIcon}
                            <div style="
                                width: 24px;
                                height: 24px;
                                background: ${color};
                                border-radius: 50%;
                                border: 2px solid #fff;
                                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 14px;
                                ${animationStyle}">
                                ${innerIcon}
                            </div>
                        </div>`;

                    const customIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: iconHtml,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    });

                    // 3. Create and Bind Marker
                    const marker = L.marker([center.lat, center.lng], { icon: customIcon });

                    const branchRow = center.branch ? `
                        <div class="info-row">
                            <span class="info-label">สาขา:</span> <span class="info-value">${center.branch}</span>
                        </div>` : '';

                    const popupContent = `
                        <div style="min-width: 200px;">
                            <h3 style="margin: 0 0 10px; color: ${color}; font-size: 1.1rem; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px;">
                                ${center.name}
                            </h3>
                            <div class="info-row">
                                <span class="info-label">จังหวัด:</span> <span class="info-value">${center.province}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ประเภท:</span> <span class="info-value">${center.type}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ระดับ:</span> <span class="info-value">${center.level}</span>
                            </div>
                            ${branchRow}
                        </div>
                    `;

                    marker.bindPopup(popupContent);
                    targetLayer.addLayer(marker);
                }
            });

            // Update Legend Counts
            document.getElementById('count-rnis').innerText = countRNIS;
            document.getElementById('count-advisor').innerText = countAdvisor;
            document.getElementById('count-high').innerText = countHigh;
            document.getElementById('count-basic').innerText = countBasic;
        }


    </script>
</body>

</html>