<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>หน่วยปฏิบัติการอำนวยการ</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #f1f5f9;
            /* Slate 100 */
            color: #334155;
            /* Slate 700 */
            font-family: 'Prompt', sans-serif;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100%;
            z-index: 1;
        }

        .header {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 5px solid #1a365d;
            /* NIEMS Navy Blue */
            max-width: 400px;
        }

        .header img {
            height: 50px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .header-text {
            display: flex;
            flex-direction: column;
        }

        .header h1 {
            margin: 0;
            font-size: 1.1rem;
            color: #1a365d;
            /* NIEMS Navy Blue */
            font-weight: 600;
            line-height: 1.2;
        }

        .header p {
            margin: 2px 0 0;
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 300;
        }

        /* Custom Marker Styles */
        .blinking-marker {
            background-color: #ef4444;
            /* Red 500 */
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 0 rgba(239, 68, 68, 0.4);
            animation: pulse 2s infinite;
        }

        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #ef4444;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .marker-pin::after {
            content: '';
            width: 14px;
            height: 14px;
            margin: 8px 0 0 8px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }

        .custom-div-icon {
            background: none;
            border: none;
        }

        .custom-div-icon i {
            position: absolute;
            width: 22px;
            height: 22px;
            left: 0;
            right: 0;
            margin: 10px auto;
            text-align: center;
            font-size: 12px;
            /* icon size */
            color: white;
            /* icon color */
            padding-top: 5px;
            /* adjust to center */
            z-index: 100;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        @keyframes pulse-gray {
            0% {
                box-shadow: 0 0 0 0 rgba(148, 163, 184, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(148, 163, 184, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(148, 163, 184, 0);
            }
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }


        /* Warning Popup */
        .leaflet-popup-content-wrapper {
            background: rgba(255, 255, 255, 0.98);
            color: #334155;
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            font-family: 'Prompt', sans-serif;
        }

        .leaflet-popup-tip {
            background: rgba(255, 255, 255, 0.98);
        }

        .leaflet-popup-content {
            margin: 14px;
        }

        .info-row {
            margin-bottom: 6px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        .info-label {
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .info-value {
            color: #1a365d;
            font-weight: 500;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            border-radius: 20px;
            z-index: 1000;
            font-size: 0.85rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            width: 300px;
        }

        .legend-title {
            margin-bottom: 15px;
            font-weight: 600;
            color: #1a365d;
            font-size: 1rem;
            text-align: center;
            letter-spacing: 0.5px;
        }

        .legend-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }

        .filter-btn.active {
            border-color: currentColor;
            transform: translateY(-1px);
            font-weight: 600;
        }

        .filter-btn.active.rnis {
            background-color: #eff6ff;
            /* Blue 50 */
            color: #1d4ed8;
            /* Blue 700 */
            border: 2px solid #93c5fd;
            /* Blue 300 */
        }

        .filter-btn.active.high {
            background-color: #f8fafc;
            /* Slate 50 */
            color: #475569;
            /* Slate 600 */
            border: 2px solid #cbd5e1;
            /* Slate 300 */
        }

        .filter-btn.active.basic {
            background-color: #f8fafc;
            /* Slate 50 */
            color: #475569;
            /* Slate 600 */
            border: 2px solid #cbd5e1;
            /* Slate 300 */
        }

        .btn-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #cbd5e1;
            transition: all 0.3s;
            border: 1px solid #e2e8f0;
            position: relative;
            /* For crown overlap */
            overflow: visible;
        }

        .btn-icon img {
            width: 18px;
            height: 18px;
            object-fit: contain;
        }

        .filter-btn.active .btn-icon {
            border-color: transparent;
        }

        /* Icon styling to match the active state text color or distinct */
        .filter-btn.active.rnis {
            background-color: #ecfdf5;
            color: #065f46;
            border: 2px solid #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .filter-btn.active.rnis .btn-icon {
            background: #10b981 !important;
            color: white;
            border: 2px solid white;
        }

        .filter-btn.active.high .btn-icon {
            background: #2563eb !important;
            border: 2px solid white;
        }

        .filter-btn.active.basic .btn-icon {
            background: #2563eb !important;
            border: 2px solid white;
        }

        .btn-icon img.telephone-icon,
        .btn-icon img.headset-icon {
            filter: brightness(0) invert(1);
        }

        .btn-label {
            font-size: 0.9rem;
        }

        .btn-count {
            background: #f1f5f9;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
        }

        .filter-btn.active .btn-count {
            background: white;
            color: currentColor;
            opacity: 0.8;
        }
    </style>
</head>

<body>

    <div class="header">
        <img src="logo-200.png" alt="NIEMS Logo">
        <div class="header-text">
            <h1>หน่วยปฏิบัติการอำนวยการ</h1>
            <p>สถาบันการแพทย์ฉุกเฉินแห่งชาติ (สพฉ.)</p>
        </div>
    </div>

    <div id="map"></div>

    <div class="legend">
        <div class="legend-title">ระดับหน่วยปฏิบัติการอำนวยการ</div>
        <div class="legend-grid">
            <div class="filter-btn active rnis" onclick="toggleLayer('rnis', this)">
                <div class="btn-content">
                    <div class="btn-icon">
                        <img src="headset.png" alt="Headset" class="headset-icon">
                        <i class="fa-solid fa-crown" style="
                            position: absolute;
                            top: -12px;
                            left: 50%;
                            transform: translateX(-50%);
                            color: #fbbf24;
                            font-size: 14px;
                            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
                        "></i>
                    </div>
                    <span class="btn-label">ยกระดับเป็นดิจิทัล</span>
                </div>
                <span class="btn-count" id="count-rnis">0</span>
            </div>

            <div class="filter-btn active high" onclick="toggleLayer('high', this)">
                <div class="btn-content">
                    <div class="btn-icon"><img src="telephone.png" alt="Telephone" class="telephone-icon"></div>
                    <span class="btn-label">ระดับสูง</span>
                </div>
                <span class="btn-count" id="count-high">0</span>
            </div>

            <div class="filter-btn active basic" onclick="toggleLayer('basic', this)">
                <div class="btn-content">
                    <div class="btn-icon"><img src="telephone.png" alt="Telephone" class="telephone-icon"></div>
                    <span class="btn-label">ระดับพื้นฐาน</span>
                </div>
                <span class="btn-count" id="count-basic">0</span>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="command-centers.js"></script>
    <script>
        ;

        // Initialize Map centered on Thailand
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            maxBounds: [
                [5.0, 97.0],  // Southwest corner
                [21.0, 106.0] // Northeast corner
            ],
            minZoom: 5,
            maxBoundsViscosity: 1.0
        }).setView([13.736717, 100.523186], 6);

        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);

        // Light Theme Base Map (CartoDB Positron)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Load Thailand Provinces GeoJSON
        fetch('https://raw.githubusercontent.com/chingchai/OpenGISData-Thailand/master/provinces.geojson')
            .then(response => response.json())
            .then(data => {

                // 1. Calculate Union of all provinces to get Thailand outline
                // This might take a moment, but for ~77 provinces it should be fast enough.
                let thailandUnion = data.features[0];
                for (let i = 1; i < data.features.length; i++) {
                    thailandUnion = turf.union(thailandUnion, data.features[i]);
                }

                // 2. Create a "World Mask" (World Polygon minus Thailand Union)
                const worldPolygon = turf.polygon([[
                    [-180, 90],
                    [-180, -90],
                    [180, -90],
                    [180, 90],
                    [-180, 90]
                ]]);

                const mask = turf.difference(worldPolygon, thailandUnion);

                // 3. Add Mask Layer (White cover for everything else)
                L.geoJSON(mask, {
                    style: {
                        color: 'transparent',
                        fillColor: '#ffffff', // White mask
                        fillOpacity: 0.8,    // 0.8 opacity to dim the world
                        weight: 0
                    }
                }).addTo(map);

                // 4. Add Province Borders (On top of mask? No, mask is around it. Provinces are inside holes.)
                // Actually we just add provinces normally for the borders.
                L.geoJSON(data, {
                    style: function (feature) {
                        return {
                            color: '#64748b',
                            weight: 1,
                            opacity: 0.5,
                            fillColor: 'transparent', // No fill needed as tiles show through
                            fillOpacity: 0
                        };
                    },
                    onEachFeature: function (feature, layer) {
                        layer.on({
                            mouseover: function (e) {
                                var layer = e.target;
                                layer.setStyle({
                                    weight: 2,
                                    color: '#0ea5e9',
                                    fillOpacity: 0.1
                                });
                            },
                            mouseout: function (e) {
                                L.geoJSON(data).resetStyle(e.target);
                                // Proper reset manually since we have custom base style
                                layer.setStyle({
                                    color: '#64748b',
                                    weight: 1,
                                    opacity: 0.5,
                                    fillOpacity: 0
                                });
                            }
                        });
                    }
                }).addTo(map);
            })
            .catch(error => console.error('Error loading GeoJSON:', error));


        // Layer Groups for Filtering
        const layers = {
            'rnis': L.layerGroup().addTo(map),
            'high': L.layerGroup().addTo(map),
            'basic': L.layerGroup().addTo(map)
        };

        // Function to Toggle Layers
        function toggleLayer(level, element) {
            // Check current state by class because we are using active class for styling
            const isActive = element.classList.contains('active');

            if (isActive) {
                map.removeLayer(layers[level]);
                element.classList.remove('active');
            } else {
                map.addLayer(layers[level]);
                element.classList.add('active');
            }
        }

        // Command Center Data is loaded from command-centers.js
        if (typeof commandCenters !== 'undefined' && Array.isArray(commandCenters)) {
            let countRNIS = 0;
            let countHigh = 0;
            let countBasic = 0;

            commandCenters.forEach(center => {
                if (center.lat && center.lng) {

                    // Count Logic
                    if (center.rnis) {
                        countRNIS++;
                    } else if (center.level && center.level.includes('ระดับสูง')) {
                        countHigh++;
                    } else {
                        countBasic++;
                    }

                    // Determine Level, Color, and Group
                    let color = '#000000'; // Black for Basic/High borders
                    let animationName = 'pulse-gray';
                    let targetLayer = layers['basic'];

                    if (center.level) {
                        if (center.rnis) {
                            // RNIS is Green for high visibility
                            targetLayer = layers['rnis'];
                            color = '#10b981';
                            animationName = 'pulse-green';
                        } else if (center.level.includes('ระดับสูง')) {
                            targetLayer = layers['high'];
                            color = '#2563eb';
                            animationName = 'pulse-blue';
                        } else {
                            color = '#2563eb';
                            animationName = 'pulse-blue';
                        }
                    }

                    const animationStyle = `animation: ${animationName} 2s infinite;`;

                    let crownIcon = '';
                    if (center.rnis) {
                        crownIcon = `<i class="fa-solid fa-crown" style="
                            position: absolute;
                            top: -26px;
                            left: 50%;
                            transform: translateX(-50%);
                            color: #fbbf24; 
                            font-size: 16px; 
                            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
                            z-index: 200;
                        "></i>`;
                    }

                    let iconSize = 14;
                    let innerIcon = `<img src="headset.png" style="width: ${iconSize}px; height: ${iconSize}px; object-fit: contain;">`;
                    let bgColor = color;
                    let iconBorderColor = '#fff';

                    if (!center.rnis) {
                        innerIcon = `<img src="telephone.png" style="width: ${iconSize}px; height: ${iconSize}px; object-fit: contain; filter: brightness(0) invert(1);">`;
                        bgColor = '#2563eb';
                        iconBorderColor = '#fff';
                    } else {
                        // Green for RNIS
                        innerIcon = `<img src="headset.png" style="width: ${iconSize}px; height: ${iconSize}px; object-fit: contain; filter: brightness(0) invert(1);">`;
                        bgColor = '#10b981';
                        iconBorderColor = '#fff';
                    }

                    const iconHtml = `<div style="position: relative;">
                        ${crownIcon}
                        <div style="
                            width: 24px;
                            height: 24px;
                            background: ${bgColor};
                            border-radius: 50%;
                            border: 2px solid ${iconBorderColor};
                            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 14px;
                            ${animationStyle}">
                            ${innerIcon}
                        </div>
                    </div>`;

                    const customIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: iconHtml,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    });

                    const marker = L.marker([center.lat, center.lng], { icon: customIcon });

                    const popupContent = `
                        <div style="min-width: 200px;">
                            <h3 style="margin: 0 0 10px; color: ${color}; font-size: 1.1rem; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px;">
                                ${center.name}
                            </h3>
                            <div class="info-row">
                                <span class="info-label">จังหวัด:</span> <span class="info-value">${center.province}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ประเภท:</span> <span class="info-value">${center.type}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ระดับ:</span> <span class="info-value">${center.level}</span>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.8rem; text-align: right; color: #64748b;">
                                ID: ${center.id || 'N/A'}
                            </div>
                        </div>
                    `;

                    marker.bindPopup(popupContent);
                    targetLayer.addLayer(marker);
                }
            });

            // Update Legend Counts
            document.getElementById('count-rnis').innerText = `${countRNIS}`;
            document.getElementById('count-high').innerText = `${countHigh}`;
            document.getElementById('count-basic').innerText = `${countBasic}`;
        }


    </script>
</body>

</html>